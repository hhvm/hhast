<?hh // strict

/**
 * Copyright (c) 2016, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional
 * grant of patent rights can be found in the PATENTS file in the same
 * directory.
 *
 */

namespace MyNamespace {

use function preg_match as analbumcover;
use function \preg_match_all as catchthesemen;

function foo(): void {
  $matches = null;

  \preg_match('/foo/', 'bar');
  \preg_match_all('/foo/', 'bar');

  \preg_match_with_matches('/foo/', 'bar', inout $matches);
  \preg_match_all_with_matches('/foo/', 'bar', inout $matches);

  \preg_match_with_matches('/foo/', 'bar', inout $matches);
  \preg_match_all_with_matches('/foo/', 'bar', inout $matches);

  \preg_match_with_matches('/foo/', 'bar', inout $matches, \PREG_UNMATCHED_AS_NULL, 42);
  \preg_match_all_with_matches(
    '/foo/',
    'bar',
    inout $matches,
    \PREG_SET_ORDER | \PREG_OFFSET_CAPTURE,
  );

  if (\preg_match_with_matches('/foo/', 'bar', inout $matches)) {
    return;
  }

  \preg_match_with_matches /* ...but trivia at the end is preserved. */ (
    '/foo/',
    'bar',
    inout/* no space here */$matches,
  );

  // Aliased.
  \preg_match_with_matches('/foo/', 'bar', inout $matches);
  \preg_match_all_with_matches('/foo/', 'bar', inout $matches);

  // Not in the root namespace.
  preg_match('/foo/', 'bar', &$matches);
  MyNamespace\preg_match_all('/foo/', 'bar', &$matches);

  // Some other functions.
  \current_ref(inout $arr);
  \key_ref(inout $arr);

  // By-ref to inout without renaming.
  \reset(inout $arr);

  $sec = $nsec = null;
  \clock_gettime(42, inout $sec, inout $nsec);
  \clock_gettime(42, inout $sec, inout $nsec);
  \clock_gettime(42, inout $sec, inout $nsec);
  \clock_gettime(42, inout $sec, inout $nsec);

  $out = null;
  \preg_replace_callback('/([a-z])/', fun('Str\\uppercase'), $str, -1, inout $out);

  // Missing arguments after migration from optional by-ref to required inout.
  $__unused_inout = null;
  \preg_replace_callback('/([a-z])/', fun('Str\\uppercase'), $str, -1, inout $__unused_inout);

  $__unused_inout = null;
  \preg_replace_callback(
    '/([a-z])/',
    fun('Str\\uppercase'),
    $str,
    -1,
    inout $__unused_inout,
  );

  $__unused_inout = null;
  \stream_socket_accept($s, \ini_get('default_socket_timeout'), inout $__unused_inout);

  // Edge cases (non-standard formatting, comments inside, etc.)
  $__unused_inout = null;
  \preg_replace_callback('/foo/','bar',$str,-1,inout $__unused_inout);
  $__unused_inout = null;
  \preg_replace_callback('/foo/', 'bar', $str, -1, inout $__unused_inout,);
  $__unused_inout = null;
  \preg_replace_callback('/foo/', 'bar', $str, -1, inout $__unused_inout, );
  $__unused_inout = null;
  \preg_replace_callback('/foo/', 'bar', $str, /* hi */ -1, inout $__unused_inout);
  $__unused_inout = null;
  \preg_replace_callback('/foo/', 'bar', $str, /* hi */ -1, inout $__unused_inout );
  $__unused_inout = null;
  \preg_replace_callback('/foo/', 'bar', $str, /* hi */ -1, inout $__unused_inout,);
  $__unused_inout = null;
  \preg_replace_callback('/foo/', 'bar', $str, /* hi */ -1, inout $__unused_inout, );
  $__unused_inout = null;
  \preg_replace_callback('/foo/', 'bar', /* hi */$str, -1, inout $__unused_inout);
  $__unused_inout = null;
  \preg_replace_callback(
    '/foo/', 'bar', $str, -1, inout $__unused_inout,
  );
  $__unused_inout = null;
  \preg_replace_callback(
    '/foo/',
    'bar',
    $str,
    -1,
    inout $__unused_inout
  );
  $__unused_inout = null;
  \preg_replace_callback(
    '/foo/',
    'bar',
    $str,  // hello
    -1,
    inout $__unused_inout
  );
  $__unused_inout = null;
  \preg_replace_callback(
    '/foo/',
    'bar',
    $str,  // hello
    -1,
    inout $__unused_inout,
  );
  $__unused_inout = null;
  \preg_replace_callback(
    '/foo/',
    'bar',
    $str,
    -1,
    inout $__unused_inout);
  $__unused_inout = null;
  \preg_replace_callback(
    '/foo/',
    'bar',
    $str,
    -1,
    inout $__unused_inout, );
  $__unused_inout = null;
  \preg_replace_callback(
    '/foo/',
    'bar',
    // hello
    $str,
    -1,
    inout $__unused_inout,
  );
  $__unused_inout = null;
  \preg_replace_callback(
    '/foo/',
    'bar',
    /* hi */ $str,
    -1,
    inout $__unused_inout,
  );
  $__unused_inout = null;
  \preg_replace_callback(
    /* hi */ '/foo/',  // hello
    /* hi */ 'bar',  // hello
    /* hi */ $str,  // hello
    -1,
    inout $__unused_inout,
  );
  $__unused_inout = null;
  \preg_replace_callback(

    /* hi */ '/foo/',  // hello

    /* hi */ 'bar',  // hello

    /* hi */ $str,  // hello
    -1,
    inout $__unused_inout,

  );

  // Inside a complicated statement.
  while (true) {
    do {
      $__unused_inout = null;
      $__unused_inout = null;
      $_ = true
        ? \preg_replace_callback('/foo/', 'bar', $str, -1, inout $__unused_inout)
        : \preg_replace_callback('/foo/', 'bar', $str, -1, inout $__unused_inout);
    } while (false);
  }

  // Fun edge case: Braceless if.
  $__unused_inout = null;
  if (true)
    \preg_replace_callback('/foo/', 'bar', $str, -1, inout $__unused_inout);

  // Compund statement with non-standard formatting.
  for (;;) { $__unused_inout = null; \preg_replace_callback('/foo/', 'bar', $str, -1, inout $__unused_inout); }

  // Multiple optional to required params.
  $out = $out2 = $out3 = $out4 = null;
  $__unused_inout = null;
  $__unused_inout_2 = null;
  $__unused_inout_3 = null;
  \ldap_parse_result($foo, $bar, inout $out, inout $__unused_inout, inout $__unused_inout_2, inout $__unused_inout_3);
  $__unused_inout = null;
  \ldap_parse_result($foo, $bar, inout $out, inout $out2, inout $out3, inout $__unused_inout);
  \ldap_parse_result($foo, $bar, inout $out, inout $out2, inout $out3, inout $out4);

  $__unused_inout = null;
  $__unused_inout_2 = null;
  \dns_get_record('example.com', \DNS_ANY, inout $__unused_inout, inout $__unused_inout_2);
  $__unused_inout = null;
  $__unused_inout_2 = null;
  \dns_get_record('example.com', \DNS_A, inout $__unused_inout, inout $__unused_inout_2);
  $__unused_inout = null;
  \dns_get_record('example.com', \DNS_A, inout $out, inout $__unused_inout);
  \dns_get_record('example.com', \DNS_A, inout $out, inout $out2);
  \dns_get_record('example.com', \DNS_A, inout $out, inout $out2, true);

  $__unused_inout = null;
  \grapheme_extract(
    'analbumcover',
    42,
    \GRAPHEME_EXTR_MAXBYTES,  // one default value provided
    // one missing default value
    0,
    inout $__unused_inout
  );

  // Method calls.
  $df = new IntlDateFormatter();
  $df->localtime('now', inout $pos);
  $df->localtime('now', inout $pos);
  (new IntlDateFormatter())->localtime('now', inout $pos);

  $not_date_formatter->localtime();
  $not_date_formatter->localtime(42);
  $not_date_formatter->localtime(42, $var);

  $a = $b = null;
  (new IntlTimeZone())->getOffset(1234567890, true, inout $a, inout $b);
}

} // end of MyNamespace


function bar(): void {
  $matches = null;
  \preg_match_with_matches('/foo/', 'bar', inout $matches);
}
